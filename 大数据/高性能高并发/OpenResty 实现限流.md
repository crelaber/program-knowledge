## ç®€ä»‹

ç›®å‰é™æµçš„è§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œä»åˆ†å¸ƒå¼è§’åº¦æ¥çœ‹ï¼Œé™æµå¯åˆ†ä¸ºåˆ†å¸ƒå¼é™æµï¼ˆæ¯”å¦‚åŸºäºSentinelæˆ–è€… Redisçš„é›†ç¾¤é™æµï¼‰å’Œå•æœºé™æµã€‚

ä»ç®—æ³•å®ç°è§’åº¦æ¥çœ‹ï¼Œé™æµç®—æ³•å¯åˆ†ä¸ºè®¡æ•°å™¨ç®—æ³•ã€æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ã€æ¼æ¡¶ç®—æ³•ã€ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚

**æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•åœ¨Nginxä¸­å¢åŠ æµæ§åŠŸèƒ½ï¼ŒåŸå› æ˜¯è€ƒè™‘åˆ°nginxçš„å¹¿æ³›ä½¿ç”¨ä¸”åŸºäºæµé‡çš„å…¥å£ä½ç½®ï¼Œè¶Šæ—©æ‹¦æˆªå¯¹åé¢ç³»ç»Ÿçš„å‹åŠ›è¶Šå°ã€‚**

## Nginx

Nginxæ˜¯ä¸€æ¬¾è½»é‡çº§çš„WebæœåŠ¡å™¨ã€åå‘ä»£ç†æœåŠ¡å™¨ï¼Œç”±äºå®ƒçš„å†…å­˜å ç”¨å°‘ï¼Œå¯åŠ¨æå¿«ï¼Œé«˜å¹¶å‘èƒ½åŠ›å¼ºï¼Œåœ¨äº’è”ç½‘é¡¹ç›®ä¸­å¹¿æ³›åº”ç”¨ã€‚

**Nginxå¯ä»¥åšçš„äº‹æƒ…å¾ˆå¤šï¼Œå½’çº³èµ·æ¥ä¸»è¦æœ‰å››å—ï¼š**

### 1ã€åå‘ä»£ç†

æ¥æ”¶Internetä¸Šçš„è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™å†…éƒ¨ç½‘ç»œä¸Šçš„æœåŠ¡å™¨ï¼Œå¹¶å°†ä»æœåŠ¡å™¨ä¸Šå¾—åˆ°çš„ç»“æœè¿”å›ç»™Internetä¸Šè¯·æ±‚è¿æ¥çš„å®¢æˆ·ç«¯

### 2ã€è´Ÿè½½å‡è¡¡

å°†å¤§é‡çš„ç”¨æˆ·è¯·æ±‚æŒ‰ç…§ä¸€å®šçš„è´Ÿè½½ç­–ç•¥åˆ†æ‘Šè½¬å‘ç»™å†…éƒ¨çš„æœåŠ¡å™¨ã€‚è´Ÿè½½å‡è¡¡ç­–ç•¥æœ‰ï¼šè½®è¯¢ï¼ˆé»˜è®¤ï¼‰ã€weightã€ip_hashã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰ã€url_hashï¼ˆç¬¬ä¸‰æ–¹ï¼‰

### 3ã€HTTPæœåŠ¡å™¨

Nginxæœ¬èº«æ˜¯ä¸€ä¸ªé™æ€èµ„æºçš„æœåŠ¡å™¨ï¼Œå¯¹é™æ€èµ„æºç¼“å­˜ï¼Œæå‡æ€§èƒ½ã€‚ä¹Ÿå¯ä»¥å®è¡ŒåŠ¨é™åˆ†ç¦»ï¼Œå°†åŠ¨æ€è¯·æ±‚è½¬å‘ç»™åå°æœåŠ¡å™¨ã€‚

### 4ã€æ­£å‘ä»£ç†

ä¸ºäº†å®‰å…¨é™åˆ¶ï¼Œæœ‰äº›å†…éƒ¨æœåŠ¡å™¨ä¸å…è®¸ç›´æ¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦å°†è¯·æ±‚è½¬å‘åˆ°ä»£ç†æœºï¼Œå†ç”±ä»£ç†æœºè®¿é—®internetã€‚

**é‚£ä¹ˆï¼ŒNginx å¦‚ä½•åšåˆ°é«˜å¹¶å‘ä¸‹çš„é«˜æ•ˆå¤„ç†ï¼Ÿ**

```
ç°åœ¨çš„è½¯ä»¶ç³»ç»Ÿä¸€èˆ¬é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œè·¨æœåŠ¡å™¨è¯·æ±‚äº§ç”Ÿäº†å¤§é‡çš„ç½‘ç»œIOï¼Œè€ŒIOç­‰å¾…ä¸¥é‡å½±å“ç³»ç»Ÿååé‡
```

Nginxé‡‡ç”¨å¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„æ–¹æ³•æ¥å¤„ç†è¯·æ±‚ï¼ŒLinuxçš„epollæ¨¡å‹åŸºäºäº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼Œå®ƒå¯ä»¥ç›‘æ§å¤šä¸ªäº‹ä»¶æ˜¯å¦å‡†å¤‡å°±ç»ªï¼Œå¦‚æœOKï¼Œé‚£ä¹ˆæ”¾å…¥epollé˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ã€‚workeråªéœ€è¦ä»epollé˜Ÿåˆ—å¾ªç¯å¤„ç†å³å¯ã€‚å®˜æ–¹æµ‹è¯•ç»“æœï¼Œå•å°èƒ½å¤Ÿæ”¯æŒäº”ä¸‡ä¸ªå¹¶è¡Œè¿æ¥ã€‚

```
Nginxé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ‰©å±•æ€§å¥½ï¼Œä½†ç”±äºé‡‡ç”¨Cè¯­è¨€ï¼Œæ¶‰åŠå¤§é‡çš„é€šä¿¡åè®®ï¼Œå¼€å‘ç¯å¢ƒå¤æ‚ï¼Œé—¨æ§›è¾ƒé«˜ã€‚æœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡ç®€å•çš„è„šæœ¬è¯­è¨€å°±å¯ä»¥å®ç°å„ç§å®šåˆ¶åŒ–åŠŸèƒ½ï¼Œå¹¶èƒ½æ–¹ä¾¿çš„é›†æˆåˆ° Nginxä¸­ï¼ŒOpenResty æ˜¯ä¸ªä¸é”™é€‰æ‹©ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹è¿™ä¸ªæ¡†æ¶
```

## ğŸŒ´ é¦–å…ˆï¼Œäº†è§£ä¸‹OpenResty

OpenResty æ˜¯ä¸€ä¸ªåŸºäº Nginx ä¸ Lua çš„é«˜æ€§èƒ½ Web æœåŠ¡å™¨ï¼Œå…¶å†…éƒ¨é›†æˆäº†å¤§é‡ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—ä»¥åŠå¤§å¤šæ•°çš„ä¾èµ–é¡¹ã€‚æ–¹ä¾¿æ­å»ºæ”¯æŒé«˜å¹¶å‘ã€é«˜æ‰©å±•æ€§çš„åŠ¨æ€ Web æœåŠ¡å’Œç½‘å…³ã€‚

åŒ…å« Nginxã€ngx_luaã€LuaJIT 2.0/2.1 (æˆ–è€…å¯é€‰çš„æ ‡å‡† Lua 5.1è§£é‡Šå™¨)ï¼Œè¿˜åŒ…å«å¾ˆå¤šå¼ºåŠ²ã€å¥½ç”¨çš„ Nginx æ¨¡å—ã€‚

> OpenResty ä½¿ç”¨ Lua ç¼–ç¨‹è¯­è¨€å¯¹ Nginx æ ¸å¿ƒä»¥åŠå„ç§ Nginx C æ¨¡å—è¿›è¡Œè„šæœ¬ç¼–ç¨‹ï¼Œå¯ä»¥å¤„ç†ä¸€ä¸‡ä»¥ä¸Šå¹¶å‘è¯·æ±‚ã€‚é€‰æ‹©OpenRestyï¼Œæ—¢æ‹¥æœ‰è„šæœ¬è¯­è¨€çš„å¼€å‘æ•ˆç‡ï¼Œä»¥åŠ Nginx é«˜å¹¶å‘ä¼˜åŠ¿ã€‚

**OpenResty ç°åœ¨æ˜¯å…¨çƒæ’åç¬¬ä¸‰çš„ Web æœåŠ¡å™¨ï¼Œç”±äºå°†Nginxæ‰©å±•æˆåŠ¨æ€æœåŠ¡å™¨ï¼Œå‘å±•åŠ¿å¤´å¾ˆçŒ›ã€‚æˆ‘ä»¬ç»å¸¸ç”¨åˆ°çš„ 12306 çš„ä½™ç¥¨æŸ¥è¯¢åŠŸèƒ½ï¼Œæˆ–è€…æ˜¯äº¬ä¸œçš„å•†å“è¯¦æƒ…é¡µï¼Œè¿™äº›é«˜æµé‡çš„èƒŒåï¼Œå…¶å®éƒ½æ˜¯ OpenResty åœ¨é»˜é»˜åœ°æä¾›æœåŠ¡ã€‚OpenResty æœ€æ“…é•¿çš„æ˜¯éƒ¨ç½²åœ¨æµé‡å…¥å£å¤„ï¼Œå¤„ç†å„ç§é«˜å¹¶å‘æµé‡ã€‚**

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/3Ohm6WHibeXIQj9bpiaJmoOdJOVKx4alHffoG9icmVkwMXic4IH6StKNvibgcKYA80eNC2JficDORDLU8Qpmrict6tZtw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

## ğŸŒ´ åº”ç”¨åœºæ™¯

- åœ¨è¯·æ±‚çœŸæ­£åˆ°è¾¾ä¸‹æ¸¸æœåŠ¡ä¹‹å‰ï¼ŒLua å¯ä»¥éšå¿ƒæ‰€æ¬²çš„åšå¤æ‚è®¿é—®æ§åˆ¶å’Œå®‰å…¨æ£€æµ‹
- ä»å¤–éƒ¨å­˜å‚¨æœåŠ¡ï¼ˆæ¯”å¦‚ redis, memcached, mysql, postgresqlï¼‰ä¸­è·å–åç«¯ä¿¡æ¯ï¼Œå¹¶ç”¨è¿™äº›ä¿¡æ¯æ¥å®æ—¶é€‰æ‹©å“ªä¸€ä¸ªåç«¯æ¥å®Œæˆä¸šåŠ¡è®¿é—®
- åœ¨å†…å®¹ handler ä¸­éšæ„ç¼–å†™å¤æ‚çš„ web åº”ç”¨ï¼Œä½¿ç”¨åŒæ­¥éé˜»å¡çš„æ–¹å¼ï¼Œè®¿é—®åç«¯æ•°æ®åº“å’Œå…¶ä»–å­˜å‚¨
- åœ¨ rewrite é˜¶æ®µï¼Œé€šè¿‡ Lua å®Œæˆéå¸¸å¤æ‚çš„ URL dispatch
- ç”¨ Lua å¯ä»¥ä¸º Nginx å­è¯·æ±‚å’Œä»»æ„ locationï¼Œå®ç°é«˜çº§ç¼“å­˜æœºåˆ¶

> Nginxé‡‡ç”¨åŸç”ŸCè¯­è¨€å¼€å‘çš„ï¼Œé€šè¿‡`nginx-lua-module` å€ŸåŠ©nginxå¼€æ”¾çš„apiï¼Œå®ç° Nginx çš„å„ç§åŠŸèƒ½è‡ªç”±æ‹¼æ¥ã€ä¸šåŠ¡å®šåˆ¶åŒ–ã€‚Luaè¯­è¨€ï¼Œå¤§å¤§é™ä½äº†å¼€å‘é—¨æ§›ã€‚

## ğŸŒ´ å¦‚ä½•äºŒæ¬¡å¼€å‘

æˆ‘ä»¬ç¼–å†™çš„Luaè„šæœ¬ä»£ç å‡åŒ…å«åœ¨æŒ‡ä»¤å‡½æ•°ä¸­ï¼ŒæŒ‡ä»¤å‡½æ•°æœ‰ä¸¥æ ¼çš„æ‰§è¡Œé¡ºåºã€‚å½“æ¥æ”¶è¯·æ±‚æ—¶ï¼Œé€šè¿‡æŒ‡ä»¤å‡½æ•°å¯¹ `request` ã€ `response`åšäºŒæ¬¡å¹²é¢„å¤„ç†ï¼Œä»è€Œå®ç°ä¸ªæ€§åŒ–ä¸šåŠ¡ã€‚

**æŒ‡ä»¤å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼š**

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/3Ohm6WHibeXKuoBtErGT6Eic02xndts9Dxg3brotmFg00CpI3lMp9x5QDSuRISUI6gfqVrACXIHcJ5Yt6Oykxkng/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

å‡½æ•°åŠŸèƒ½è¯´æ˜ï¼š

```
set_by_luaï¼Œç”¨äºè®¾ç½®å˜é‡
rewrite_by_luaï¼Œç”¨äºè½¬å‘ã€é‡å®šå‘ç­‰
access_by_luaï¼Œç”¨äºå‡†å…¥ã€æƒé™ç­‰
content_by_luaï¼Œç”¨äºç”Ÿæˆè¿”å›å†…å®¹
header_filter_by_luaï¼Œç”¨äºå“åº”å¤´è¿‡æ»¤å¤„ç†
body_filter_by_luaï¼Œç”¨äºå“åº”ä½“è¿‡æ»¤å¤„ç†
log_by_luaï¼Œç”¨äºæ—¥å¿—è®°å½•
```

> æ³¨æ„ï¼šOpenResty çš„ API æœ‰èŒƒå›´é™åˆ¶ï¼Œæ¯ä¸€ä¸ª API éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ä½¿ç”¨é˜¶æ®µåˆ—è¡¨ï¼Œå¦‚æœä½ è¶…èŒƒå›´ä½¿ç”¨å°±ä¼šæŠ¥é”™ã€‚

## ğŸŒ´ é™æµå®æˆ˜

OpenResty å®˜æ–¹æä¾›äº†å°è£…å¥½çš„ luaå‡½æ•°ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¼€ç®±å³ç”¨ã€‚æ”¯æŒä¸€ä¸‹å‡ ä¸ªåœºæ™¯ï¼š

- æ ¹æ®ipé™åˆ¶å¹¶å‘è¿æ¥æ•°
- é™åˆ¶æ—¶é—´çª—å£çš„è¯·æ±‚æ•°ï¼Œå¦‚ï¼šé™åˆ¶ ip æ¯åˆ†é’Ÿåªèƒ½è°ƒç”¨ 100 æ¬¡ /order æ¥å£ï¼Œï¼ˆå…è®¸åœ¨æ—¶é—´æ®µå¼€å§‹çš„æ—¶å€™ä¸€æ¬¡æ€§æ”¾è¿‡100ä¸ªè¯·æ±‚ï¼‰
- å¹³æ»‘é™åˆ¶æ¥å£è¯·æ±‚æ•°ï¼Œå¦‚ï¼šé™åˆ¶ ip æ¯åˆ†é’Ÿåªèƒ½è°ƒç”¨ 120 æ¬¡ /order æ¥å£ï¼ˆå¹³æ»‘å¤„ç†è¯·æ±‚ï¼Œå³æ¯ç§’æ”¾è¿‡2ä¸ªè¯·æ±‚ï¼‰
- æ¼æ¡¶ç®—æ³•é™æµï¼Œå¦‚ï¼šé™åˆ¶ ip æ¯åˆ†é’Ÿåªèƒ½è°ƒç”¨ 120 æ¬¡ /order æ¥å£ï¼ˆå¹³æ»‘å¤„ç†è¯·æ±‚ï¼Œå³æ¯ç§’æ”¾è¿‡2ä¸ªè¯·æ±‚ï¼‰ï¼Œè¶…è¿‡çš„éƒ¨åˆ†è¿›å…¥æ¡¶ä¸­ç­‰å¾…ï¼Œï¼ˆæ¡¶å®¹é‡ä¸º60ï¼‰ï¼Œå¦‚æœæ¡¶ä¹Ÿæ»¡äº†ï¼Œåˆ™è¿›è¡Œé™æµ

## **Luaè„šæœ¬**

```lua
 server {
        listen       80;
        server_name  localhost;
        charset utf-8;
        #access_log  logs/host.access.log  main;
 
        # é™æµç¤ºä¾‹
        location /order/limit {

            default_type 'text/html';
            access_by_lua_block {

                -- å¯¼å…¥æ¨¡å—
                local limit_count = require "resty.limit.count"
         
                -- é™æµè§„åˆ™: æ¯åˆ†é’Ÿ3æ¬¡
                local lim, err = limit_count.new("my_limit_count_store", 3, 60)
                if not lim then
                    ngx.log(ngx.ERR, "failed to instantiate a resty.limit.count object: ", err)
                    return ngx.exit(500)
                end
         
                local key = ngx.var.binary_remote_addr
                local delay, err = lim:incoming(key, true)
                -- å¦‚æœè¯·æ±‚æ•°åœ¨é™åˆ¶èŒƒå›´å†…ï¼Œåˆ™å½“å‰è¯·æ±‚è¢«å¤„ç†çš„å»¶è¿Ÿï¼ˆè¿™ç§åœºæ™¯ä¸‹å§‹ç»ˆä¸º0ï¼Œå› ä¸ºè¦ä¹ˆè¢«å¤„ç†è¦ä¹ˆè¢«æ‹’ç»ï¼‰å’Œå°†è¢«å¤„ç†çš„è¯·æ±‚çš„å‰©ä½™æ•°
                 ngx.log(ngx.ERR,"delay: ",delay," err: ",err)
                if not delay then
                    if err == "rejected" then
                        ngx.say("è®¿é—®å¤ªé¢‘ç¹äº†..","delay: ",delay," , err: ",err)
                        -- return ngx.exit(503)
                    end
         
                    ngx.log(ngx.ERR, "è¢«é™æµå•¦...... ", err)
                    return ngx.exit(500)
                end

                ngx.say("success")
            }
         
           
        }
```

## **åœºæ™¯æµ‹è¯•ï¼š**

> æµæ§è®¾ç½®è§„åˆ™ï¼Œæ¯åˆ†é’Ÿé™åˆ¶è®¿é—®3æ¬¡

**æ­£å¸¸è¯·æ±‚ï¼š**

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/3Ohm6WHibeXKuoBtErGT6Eic02xndts9Dx67uMgr6tFbmXlKGo8mNicpZzd89CzDzBqJ7C5Fv4agHicOEIY2iaYvU0w/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

**è¯·æ±‚è¿‡å¤šï¼Œè§¦å‘æµæ§ï¼š**

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/3Ohm6WHibeXKuoBtErGT6Eic02xndts9Dx9FlKTBOtP3xuxVgIdRicbtSPOMP3OpKxEqMuLHCY4dKfv8OBiaQcKvag/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)